registrationModule.controller("notificacionController",function(e,r,n,t,a,i,o,c){e.oneAtATime=!0,e.isSearching=!1,e.alphaOrder=!1,e.tooltipAlphabeth="Ordenar Descencente",e.dateOrder=!0,e.tooltipDate="Ordenar Ascendente",e.currentOrder=0,e.filtrado=!1,e.nivelCascada=1,e.socket=null,e.connected=!1,e.init=function(){n.actualizar=!0,e.currentMarca=null,e.hora=new Date,e.txtAlphaOrder="+identificador",e.txtDateOrder="-fecha",setInterval(function(){e.ReloadTime()},1e3),setInterval(function(){},500),$("#lgnUser").val().indexOf("[")>-1?$("#lgnUser").val().indexOf("[")>-1&&!t.get("lgnUser")&&(""!=getParameterByName("employee")?n.currentEmployee=getParameterByName("employee"):(alert("Inicie sesión desde panel de aplicaciones."),window.close())):t.set("lgnUser",$("#lgnUser").val()),null==n.currentEmployee&&(n.currentEmployee=t.get("lgnUser")),c.getEmpleado(n.currentEmployee).success(d).error(u),n.Reload(),D(),setInterval(function(){e.connected||""==n.currentEmployee||(console.log("Intentando reconexión..."),l())},1e4)};var l=function(){e.socket=io.connect(global_settings.urlSocket),null!=e.socket&&s()},s=function(){e.socket.emit("login",{user:n.empleado}),e.socket.on("hello",function(r){console.log(r.mensaje),e.connected=!0}),e.socket.on("pkgNotificacion",function(e){console.log(e.length+" dato(s) recibido(s) at: "+(new Date).toString()),p(e,null,null,null)}),e.socket.on("pkgAprobacion",function(e){console.log(e.length+" Aprobacion(es) recibida(s) at: "+(new Date).toString()),g(e,null,null,null)}),e.socket.on("disconnect",function(){console.log("Se ha desconectado."),e.connected=!1})},u=function(e,r,n,t){a.error("Ocurrio un problema: "+e),$("#btnReject").button("reset"),$("#btnApprove").button("reset")},d=function(e,r,t,a){n.empleado=e,l()},p=function(r,t,i,o){if(null!=e.listaNotificacion_original){var c=e.listaNotificacion_original.length;n.actualizar&&(e.listaNotificacion_original=r,f(),1==e.currentOrder?h():e.alphaOrder&&A(),r.length>c&&a.info((r.length-c).toString()+" nuevas notificaciones."))}else e.listaNotificacion_original=r,f()},f=function(){null!=e.currentMarca&&null!=e.currentAgencia&&null!=e.currentDepartamento?e.listaNotificacion=r("filter")(e.listaNotificacion_original,{idEmpresa:e.currentMarca.emp_idempresa,idSucursal:e.currentAgencia.suc_idsucursal,idDepartamento:e.currentDepartamento.dep_iddepartamento},!0):null!=e.currentMarca&&null!=e.currentAgencia?e.listaNotificacion=r("filter")(e.listaNotificacion_original,{idEmpresa:e.currentMarca.emp_idempresa,idSucursal:e.currentAgencia.suc_idsucursal},!0):null!=e.currentMarca?e.listaNotificacion=r("filter")(e.listaNotificacion_original,{idEmpresa:e.currentMarca.emp_idempresa},!0):e.listaNotificacion=e.listaNotificacion_original},g=function(r,n,t,a){if(null!=e.listaAprobacion_original){var i=e.listaAprobacion_original.length;r.length!=i&&(e.listaAprobacion_original=r,m(),1==e.currentOrder?h():A())}else e.listaAprobacion_original=r,m()},m=function(){null!=e.currentMarca&&null!=e.currentAgencia&&null!=e.currentDepartamento?e.listaAprobacion=r("filter")(e.listaAprobacion_original,{idEmpresa:e.currentMarca.emp_idempresa,idSucursal:e.currentAgencia.suc_idsucursal,idDepartamento:e.currentDepartamento.dep_iddepartamento},!0):null!=e.currentMarca&&null!=e.currentAgencia?e.listaAprobacion=r("filter")(e.listaAprobacion_original,{idEmpresa:e.currentMarca.emp_idempresa,idSucursal:e.currentAgencia.suc_idsucursal},!0):null!=e.currentMarca?e.listaAprobacion=r("filter")(e.listaAprobacion_original,{idEmpresa:e.currentMarca.emp_idempresa},!0):e.listaAprobacion=e.listaAprobacion_original};n.Reload=function(){i.get(n.currentEmployee).success(p).error(u),o.get(n.currentEmployee).success(g).error(u)},e.VerDocumento=function(e){var r=e.adjunto,n=r.split("|");n.forEach(function(r){var n=window.open(e.ruta_archivos+r,"_blank","toolbar=yes, scrollbars=yes, resizable=yes, top=500, left=500, width=1024, height=768")})},e.VerBusiness=function(e){var r=window.open(e.link,"_blank","toolbar=yes, scrollbars=yes, resizable=yes, top=500, left=500, width=1024, height=768")},e.ReloadTime=function(){e.hora=new Date,e.$apply()},e.Visto=function(e){n.actualizar=!e.open,0==e.estado&&(o.visto(n.currentEmployee,e.idAprobacion).error(u),e.estado=1)},e.ViewSearch=function(){e.isSearching=!e.isSearching,$("#slideIzq").animate({width:"toggle"}),0==e.isSearching&&($("#slideIzq").blur(),$("#slideIzq").val(""),e.keySearch="")},e.TextSearch=function(){e.keySearch=$("#slideIzq").val()},e.AlphaOrder=function(){e.currentOrder=2,e.alphaOrder=!e.alphaOrder,1==e.alphaOrder?(e.tooltipAlphabeth="Ordenar Ascendente",e.txtAlphaOrder="-identificador",A()):(e.tooltipAlphabeth="Ordenar Descencente",e.txtAlphaOrder="+identificador",A())};var A=function(){e.listaNotificacion=r("orderBy")(e.listaNotificacion,e.txtAlphaOrder),e.listaAprobacion=r("orderBy")(e.listaAprobacion,e.txtAlphaOrder)};e.DateOrder=function(){e.currentOrder=1,e.dateOrder=!e.dateOrder,1==e.dateOrder?(e.tooltipDate="Ordenar Ascendente",e.txtDateOrder="-fecha",h()):(e.tooltipDate="Ordenar Descencente",e.txtDateOrder="+fecha",h())};var h=function(){e.listaNotificacion=r("orderBy")(e.listaNotificacion,e.txtDateOrder),e.listaAprobacion=r("orderBy")(e.listaAprobacion,e.txtDateOrder)};e.ViewFiltro=function(){$("#modalFiltro").modal("show")},e.AplicarFiltro=function(){e.filtrado=!0,f(),m(),$("#modalFiltro").modal("hide")},e.QuitarFiltro=function(){e.filtrado=!1,e.nivelCascada=1,e.currentMarca=null,e.currentAgencia=null,e.currentDepartamento=null,f(),m(),$("#modalFiltro").modal("hide")};var b=function(r,n,t,a){e.listaMarca=r},O=function(r,n,t,a){e.listaAgencia=r},_=function(r,n,t,a){e.listaDepartamento=r},D=function(){c.getMarca(n.currentEmployee).success(b).error(u)};e.GetAgencia=function(){c.getAgencia(n.currentEmployee,e.currentMarca.emp_idempresa).success(O).error(u)},e.GetDepartamento=function(){c.getDepartamento(n.currentEmployee,e.currentMarca.emp_idempresa,e.currentAgencia.suc_idsucursal).success(_).error(u)},e.SetMarca=function(r){e.currentMarca=r,e.GetAgencia(),e.nivelCascada=2,e.currentAgencia=null,e.currentDepartamento=null},e.SetAgencia=function(r){e.currentAgencia=r,e.GetDepartamento(),e.nivelCascada=3,e.currentDepartamento=null},e.SetDepartamento=function(r){e.currentDepartamento=r}});